.volta:
  image: debian:12
  before_script:
    - apt-get update && apt-get install -y curl git jq moreutils
    - export VOLTA_HOME=/root/.volta
    - export PATH=$VOLTA_HOME/bin:$PATH
    - curl https://get.volta.sh | bash -s -- --skip-setup
    - yarn config set enableGlobalCache false
    - yarn config set enableImmutableInstalls true
    - yarn install

  cache:
    paths:
      - .yarn/cache/

pages:
  stage: deploy
  extends: .volta
  rules:
    # build on tags, but not pre-releases
    - if: $CI_COMMIT_TAG =~ /^@churros\/api@(\d+\.\d+\.\d+)/
    # allow manual triggers
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  script:
    - yarn workspace @churros/api install --immutable
    - yarn generate-buildinfo
    - yarn workspace @churros/api graphinx build ../../public
  artifacts:
    paths:
      - public
