.changesets:
  image: 
    name: registry.inpt.fr/inp-net/changesets-gitlab-docker
    entrypoint: [""]
  before_script:
    - export GITLAB_TOKEN=$CHANGESETS_TOKEN
    - |
      cat << EOF > "$HOME/.npmrc"
        email=$NPM_EMAIL
        //registry.npmjs.org/:_authToken=$NPM_TOKEN
      EOF
  cache:
    paths:
      - .yarn/cache/

comment:
  extends: .changesets
  stage: changesets
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - changesets-gitlab comment

renovate-changesets:
  image: node:20-alpine
  stage: changesets
  before_script:
   - apk add git
  script:
   - echo "Running renovate changeset generator..."
   - npm install
   - node scripts/generate-renovate-changesets
   - git push
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
    - if: '$CI_COMMIT_REF_NAME == "main"'
      changes:
      - scripts/generate-renovate-changesets # Only run when this script is touched
    - if: '$CI_COMMIT_REF_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^renovate\//'
      when: always # Runs only when a MR from a renovate/ branch is merged into main                                     

release:
  extends: .changesets
  stage: changesets
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    INPUT_TITLE: 'chore: version packages'
    INPUT_COMMIT: 'chore: version packages'
    YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
    INPUT_VERSION: '/bin/sh scripts/update-versions.sh'
    INPUT_PUBLISH: 'changeset tag'
  script:
    - changesets-gitlab
