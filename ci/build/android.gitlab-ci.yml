.android:
  extends: .build
  variables:
    TARGET: android
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_SUBMODULE_PATHS: packages/app/android
  script:
    - eval $TAG
    - |
      buildctl-daemonless.sh build \
          --frontend=dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --opt target=$TARGET \
          --opt build-arg:TAG=$TAG \
          --opt build-arg:CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX=$CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX \
          $BUILD_SECRET_SENTRY \
          --output type=local,dest=.
  artifacts:
    paths:
      - churros.apk
      - output-metadata.json

build:android:
  extends: .android
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE !~ /^(\[Draft\]|\(Draft\)|Draft:)/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE =~ /^(\[Draft\]|\(Draft\)|Draft:)/
      when: manual
  artifacts:
    expire_in: 1 day

deploy:android:
  extends: .android
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG =~ /^@churros\/app@(\d+\.\d+\.\d+)/
      variables:
        ENV: "production"
        URL: "https://churros.inpt.fr"
        TAG: export TAG=$(echo $CI_COMMIT_TAG | sed 's/@churros\/app@//')
        DEPLOY: "false"
  environment:
    name: $ENV
    url: $URL
  artifacts:
    expire_in: 1 week
