.app:
  extends: .build
  variables:
    TARGET: app
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_SUBMODULE_FORCE_HTTPS: "true"
  artifacts:
    paths:
      - churros.apk
      - output-metadata.json

.build:app:
  extends: .app
  stage: build
  needs: 
    - job: test:app:lint
      optional: true
    - job: test:app:format
      optional: true
    - job: test:app:svelte-check
      optional: true
  artifacts:
    expire_in: 4 days
    paths: [churros.apk, output-metadata.json]
  variables:
    BUILD_APK: "false"
  script:
    - !reference [.build, script]
    - |
      if [ "$BUILD_APK" = "true" ]; then \
        buildctl-daemonless.sh build \
            --frontend=dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --opt target=android \
            --opt build-arg:TAG=$TAG \
            --opt build-arg:CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX=$CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX \
            $BUILD_SECRET_SENTRY \
            --output type=local,dest=. \
        mv app-debug.apk churros.apk \
      fi

build:app:
  extends: .build:app
  rules: 
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE !~ /^(\[Draft\]|\(Draft\)|Draft:)/
      changes: [packages/app/**/*]
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE =~ /^(\[Draft\]|\(Draft\)|Draft:)/
      when: manual

build:app-with-native:
  extends: .build:app
  variables:
    BUILD_APK: "true"
  rules: 
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE !~ /^(\[Draft\]|\(Draft\)|Draft:)/
      changes: [packages/app/android/**/*]
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  before_script:
    - !reference [.build, before_script]
    # cancel sibling build:app job with the gitlab API
    - |
      job_id=$(curl --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/pipelines/$CI_PIPELINE_ID/jobs" | jq -r '.[] | select(.name == "build:app") | .id')
      curl --request POST --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/jobs/$job_id/cancel"


deploy:apk:
  stage: deploy
  needs: [build:app-with-native]
  image: curlimages/curl
  rules:
    - when: manual
  script:
    - |
      curl https://upload.diawi.com/ -F token="$DIAWI_TOKEN" \
        -F file=@churros.apk \
        -F callback_emails="$GITLAB_USER_EMAIL" \
        -F comment="APK built against $CI_COMMIT_SHA in $CI_PIPELINE_URL"

deploy:app:
  extends: .app
  stage: deploy
  interruptible: false
  rules:
    - if: $CI_COMMIT_TAG =~ /^@churros\/app@(\d+\.\d+\.\d+)/
      variables:
        ENV: "production"
        URL: "https://churros.inpt.fr"
        TAG: export TAG=$(echo $CI_COMMIT_TAG | sed 's/@churros\/app@//')
        DEPLOY: "true"
  environment:
    name: $ENV
    url: $URL
  script:
    - !reference [.build, script]
    - |
      buildctl-daemonless.sh build \
          --frontend=dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --opt target=android \
          --opt build-arg:TAG=$TAG \
          --opt build-arg:CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX=$CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX \
          $BUILD_SECRET_SENTRY \
          --output type=local,dest=.
